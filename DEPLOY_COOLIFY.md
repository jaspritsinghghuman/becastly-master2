# ğŸš€ Coolify Deployment Guide

Deploy Becastly on your Coolify instance.

## âš ï¸ The Problem

Coolify uses **Nixpacks** which generates its own Dockerfile and runs `npm ci` **without** `--legacy-peer-deps`. This causes dependency conflicts.

## âœ… Solution: Use Docker Compose Build Pack

### Step 1: In Coolify Dashboard

1. Go to **Projects** â†’ **New Project**
2. Name it: `becastly`
3. Click **Add Resource**
4. Select **Docker Compose** (not "Application")

### Step 2: Configure Build Pack

1. **Repository**: `https://github.com/jaspritsinghghuman/becastly`
2. **Branch**: `main`
3. **Build Pack**: Select **Docker Compose**
4. **Compose File Path**: `coolify.yaml`

### Step 3: Environment Variables

Add these in Coolify â†’ Environment Variables:

```env
POSTGRES_USER=becastly
POSTGRES_PASSWORD=your_secure_password
POSTGRES_DB=becastly
ENCRYPTION_KEY=your_32_char_key
COOLIFY_URL=https://your-coolify-domain.com
```

### Step 4: Deploy

Click **Deploy** and wait for the build.

---

## ğŸ”§ Alternative: Fix npm for Nixpacks

If you want to use Coolify's Application (Nixpacks), create `.npmrc`:

```bash
# Create .npmrc file
cat > .npmrc << 'EOF'
legacy-peer-deps=true
EOF
```

Then commit and push:
```bash
git add .npmrc
git commit -m "Add npm legacy peer deps config"
git push origin main
```

Now Coolify should use this setting.

---

## ğŸ³ Method 3: Custom Dockerfile for Coolify

Create `Dockerfile.coolify`:

```dockerfile
FROM node:20-alpine

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci --legacy-peer-deps

# Copy prisma schema
COPY prisma ./prisma/
RUN npx prisma generate

# Copy source and build
COPY . .
RUN npm run build

EXPOSE 3001

CMD ["node", "dist/app.js"]
```

In Coolify, set **Dockerfile Path**: `Dockerfile.coolify`

---

## ğŸ“‹ Required Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `POSTGRES_USER` | Database user | `becastly` |
| `POSTGRES_PASSWORD` | Database password | `secure_password` |
| `POSTGRES_DB` | Database name | `becastly` |
| `ENCRYPTION_KEY` | 32-char key for encryption | `abc123...` |
| `COOLIFY_URL` | Your Coolify domain | `https://app.example.com` |
| `DATABASE_URL` | Auto-generated by Coolify | (optional) |
| `REDIS_URL` | Auto-generated by Coolify | (optional) |

---

## ğŸ¯ Recommended Approach for Coolify

### Option A: Docker Compose (Recommended)

Use the `coolify.yaml` file which includes all services:
- PostgreSQL
- Redis
- API
- Worker
- Frontend

### Option B: Separate Resources

Create **separate resources** in Coolify:

1. **PostgreSQL** â†’ Use Coolify's managed database
2. **Redis** â†’ Use Coolify's managed Redis
3. **API** â†’ Deploy from repo, Dockerfile path: `Dockerfile`
4. **Frontend** â†’ Deploy from repo, Dockerfile path: `frontend/Dockerfile`

---

## ğŸ†˜ Troubleshooting

### "npm error ERESOLVE could not resolve"

**Fix**: Ensure you're using Docker Compose build pack, not Nixpacks.

### "Cannot connect to database"

**Fix**: Check `DATABASE_URL` environment variable is set correctly.

### "Build takes too long"

**Fix**: This is normal for first build. Subsequent builds use cache.

---

## ğŸ”— Useful Links

- **Coolify Docs**: https://coolify.io/docs/
- **Docker Compose**: https://docs.docker.com/compose/
- **Your Repo**: https://github.com/jaspritsinghghuman/becastly

---

**Need help?** Check Coolify Discord or GitHub issues!
